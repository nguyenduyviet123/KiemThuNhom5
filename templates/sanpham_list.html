{% extends "base.html" %}
{% block title %}Qu·∫£n l√Ω S·∫£n ph·∫©m{% endblock %}

{% block content %}
<div class="header">üç∞ Qu·∫£n l√Ω S·∫£n ph·∫©m</div>

<!-- T√¨m ki·∫øm s·∫£n ph·∫©m -->
<div class="search-bar" style="position:relative; text-align:center; margin:15px 0;">
  <i class="fa-solid fa-magnifying-glass"
     style="position:absolute; left:calc(50% - 140px); top:10px; color:#888;"></i>
  <input type="text" id="searchInput"
         placeholder="T√¨m s·∫£n ph·∫©m theo t√™n ho·∫∑c lo·∫°i..."
         style="width:300px; padding:8px 12px 8px 32px; border-radius:8px; border:1px solid #ccc;">
  <div id="suggestions"
       style="position:absolute; top:110%; left:50%; transform:translateX(-50%);
              width:300px; background:#fff; border-radius:8px; border:1px solid #ddd;
              box-shadow:0 4px 10px rgba(0,0,0,0.15); z-index:9999; display:none;">
  </div>
</div>


<div class="action-bar">
  <a href="{{ url_for('sanpham_add') }}">
    <button class="add-btn">‚ûï Th√™m s·∫£n ph·∫©m</button>
  </a>
</div>

<div class="product-grid">
  {% for p in products %}
  <div class="product-card">
    <img src="{{ p.Anh or url_for('static', filename='img/noimage.png') }}" alt="{{ p.TenSP_ }}">
    <div class="product-info">
      <h4>{{ p.TenSP_ }}</h4>
      <p class="price">{{ "{:,.0f}".format(p.DonGia) }} ƒë</p>

      <!-- üïì Hi·ªÉn th·ªã th·ªùi gian c·∫≠p nh·∫≠t -->
      <small class="update-time">
        üïì C·∫≠p nh·∫≠t:
        {{ p.ThoiGianCapNhat.strftime('%d/%m/%Y %H:%M') if p.ThoiGianCapNhat else 'Ch∆∞a c√≥' }}
      </small>

      <div class="actions">
        <a href="{{ url_for('sanpham_edit', ma=p.MaSP) }}" title="S·ª≠a">
          <button class="icon-btn edit"><i>‚úèÔ∏è</i></button>
        </a>
        <form method="post" action="{{ url_for('sanpham_delete', ma=p.MaSP) }}" style="display:inline;">
          <button class="icon-btn delete" type="submit" title="X√≥a" onclick="return confirm('X√≥a s·∫£n ph·∫©m n√†y?')">üóëÔ∏è</button>
        </form>
        <a href="{{ url_for('sanpham_view', ma=p.MaSP) }}" class="icon-btn detail" title="Xem chi ti·∫øt">
          üîç
          <div class="preview-box">
            <img src="{{ p.Anh or url_for('static', filename='img/noimage.png') }}" alt="{{ p.TenSP_ }}">
            <h4>{{ p.TenSP_ }}</h4>
            <p><b>M√£:</b> {{ p.MaSP }}</p>
            <p><b>Lo·∫°i:</b> {{ p.TenLoai or p.MaLoai }}</p>
            <p>
              <b>Gi√°:</b>
              <span class="price-new">{{ "{:,.0f}".format(p.DonGia) }}ƒë</span>
              <span class="price-old">{{ "{:,.0f}".format(p.GiaCu) }}ƒë</span>
            </p>
            <p class="desc"><b>M√¥ t·∫£:</b> {{ p.MoTa or 'Ch∆∞a c√≥ m√¥ t·∫£' }}</p>

            <!-- üïì Hi·ªÉn th·ªã th·ªùi gian c·∫≠p nh·∫≠t trong tooltip -->
            <p><b>üïì C·∫≠p nh·∫≠t:</b> {{ p.ThoiGianCapNhat.strftime('%d/%m/%Y %H:%M') if p.ThoiGianCapNhat else 'Ch∆∞a c√≥' }}</p>
          </div>
        </a>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Modal Chi ti·∫øt s·∫£n ph·∫©m -->
<div id="detailModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function viewDetail(maSP) {
  fetch(`/api/sanpham/${maSP}`)
    .then(res => res.json())
    .then(p => {
      const body = document.getElementById("modal-body");
      body.innerHTML = `
        <h2>${p.TenSP_}</h2>
        <img src="${p.Anh}" alt="${p.TenSP_}" style="max-width:250px;border-radius:10px;margin:10px 0;">
        <p><b>Gi√°:</b> ${p.DonGia.toLocaleString('vi-VN')} ƒë</p>
        <p><b>M√¥ t·∫£:</b> ${p.MoTa || 'Ch∆∞a c√≥ m√¥ t·∫£'}</p>
        <p><b>Lo·∫°i:</b> ${p.MaLoai}</p>
      `;
      document.getElementById("detailModal").style.display = "block";
    });
}

function closeModal() {
  document.getElementById("detailModal").style.display = "none";
}

// ‚úÖ T√¨m ki·∫øm s·∫£n ph·∫©m
function searchSanPham() {
  const query = document.getElementById("searchInput").value.trim();
  const suggestBox = document.getElementById("suggestions");
  if (!query) {
    suggestBox.innerHTML = "";
    suggestBox.style.display = "none";
    return;
  }

  fetch(`/api/search_sanpham?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data)) {
        console.error("API tr·∫£ v·ªÅ sai ƒë·ªãnh d·∫°ng:", data);
        return;
      }
      if (data.length === 0) {
        suggestBox.innerHTML = `<div style="padding:8px;color:#888;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</div>`;
      } else {
        suggestBox.innerHTML = data.map(p => `
          <div class="suggestion-item"
               style="padding:8px; cursor:pointer; border-bottom:1px solid #eee;"
               onclick="goToProduct('${p.MaSP.trim()}')">
            <b>${p.TenSP_}</b> <span style="color:#888;">(${p.TenLoai})</span>
          </div>
        `).join("");
      }
      suggestBox.style.display = "block";
    })
    .catch(err => console.error("L·ªói fetch:", err));
}

function goToProduct(ma) {
  window.location.href = `/sanpham/view/${ma}`;
}

// ‚úÖ X·ª≠ l√Ω ph√≠m Enter
document.addEventListener("DOMContentLoaded", () => {
  const input = document.getElementById("searchInput");
  const suggestBox = document.getElementById("suggestions");

  // üîç Khi ng∆∞·ªùi d√πng g√µ
  input.addEventListener("input", () => {
    const query = input.value.trim();
    if (!query) {
      suggestBox.innerHTML = "";
      suggestBox.style.display = "none";
      return;
    }

    fetch(`/api/search_sanpham?q=${encodeURIComponent(query)}`)
      .then(res => res.json())
      .then(data => {
        if (!Array.isArray(data)) return;
        if (data.length === 0) {
          suggestBox.innerHTML = `<div style="padding:8px;color:#888;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</div>`;
        } else {
          suggestBox.innerHTML = data.map(p => `
            <div class="suggestion-item"
                 style="padding:8px; cursor:pointer; border-bottom:1px solid #eee;"
                 onclick="window.location.href='/sanpham/view/${p.MaSP.trim()}'">
              <b>${p.TenSP_}</b> <span style="color:#888;">(${p.TenLoai})</span>
            </div>
          `).join("");
        }
        suggestBox.style.display = "block";
      })
      .catch(err => console.error("‚ùå L·ªói fetch:", err));
  });

  // B·∫•m Enter ch·ªçn k·∫øt qu·∫£ ƒë·∫ßu ti√™n
  input.addEventListener("keydown", (e) => {
    if (e.key === "Enter") {
      e.preventDefault();
      const firstItem = document.querySelector(".suggestion-item");
      if (firstItem) firstItem.click();
    }
  });

  // Click ra ngo√†i ·∫©n g·ª£i √Ω
  document.addEventListener("click", (e) => {
    if (!suggestBox.contains(e.target) && e.target !== input) {
      suggestBox.style.display = "none";
    }
  });
});
</script>
{% endblock %}
