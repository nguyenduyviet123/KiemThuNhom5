{% extends "base.html" %}
{% block title %}Qu·∫£n l√Ω S·∫£n ph·∫©m{% endblock %}

{% block content %}
<div class="header">üç∞ Qu·∫£n l√Ω S·∫£n ph·∫©m</div>

{# ======================================================= #}
{# == ƒêO·∫†N CODE ƒê·ªÇ HI·ªÇN TH·ªä TH√îNG B√ÅO (FLASH MESSAGE) == #}
{# ======================================================= #}
{% with messages = get_flashed_messages(with_categories=true) %}
  {% if messages %}
    {% for category, message in messages %}
      <div class="alert alert-{{ category }} alert-dismissible fade show" role="alert">
        {{ message }}
        <button type="button" class="close" data-dismiss="alert" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
    {% endfor %}
  {% endif %}
{% endwith %}

<!-- T√¨m ki·∫øm s·∫£n ph·∫©m -->
<div class="search-bar" style="position:relative; text-align:center; margin:15px 0;">
  <i class="fa-solid fa-magnifying-glass"
     style="position:absolute; left:calc(50% - 140px); top:10px; color:#888;"></i>
  <input type="text" id="searchInput"
         placeholder="T√¨m s·∫£n ph·∫©m theo t√™n ho·∫∑c lo·∫°i..."
         style="width:300px; padding:8px 12px 8px 32px; border-radius:8px; border:1px solid #ccc;">
  <div id="suggestions"
       style="position:absolute; top:70%; left:50%; transform:translateX(-50%);
              width:300px; background:#fff; border-radius:8px; border:1px solid #ddd;
              box-shadow:0 4px 10px rgba(0,0,0,0.15); z-index:9999; display:none;">
  </div>
</div>


<div class="action-bar">
  <a href="{{ url_for('sanpham_add') }}">
    <button class="add-btn">‚ûï Th√™m s·∫£n ph·∫©m</button>
  </a>
</div>

<div class="product-grid" id="productGrid">
  {% for p in products %}
  <div class="product-card">
    <img src="{{ p.Anh or url_for('static', filename='img/noimage.png') }}" alt="{{ p.TenSP_ }}">
    <div class="product-info">
      <small class="product-code">M√£ SP: {{ p.MaSP }}</small>
      <h4>{{ p.TenSP_ }}</h4>
      <p class="category">
        <!--Th√™m lo·∫°i-->
        Lo·∫°i: {{ p.TenLoai or p.MaLoai }}
      </p>
      <p class="price">{{ "{:,.0f}".format(p.DonGia) }} ƒë</p>

      <!-- üïì Hi·ªÉn th·ªã th·ªùi gian c·∫≠p nh·∫≠t -->
      <small class="update-time">
        üïì C·∫≠p nh·∫≠t:
        {{ p.ThoiGianCapNhat.strftime('%d/%m/%Y %H:%M') if p.ThoiGianCapNhat else 'Ch∆∞a c√≥' }}
      </small>

      <div class="actions">
        <a href="{{ url_for('sanpham_edit', ma=p.MaSP) }}" title="S·ª≠a">
          <button class="icon-btn edit"><i>‚úèÔ∏è</i></button>
        </a>
        <form method="post" action="{{ url_for('sanpham_delete', ma=p.MaSP) }}" style="display:inline;">
          <button class="icon-btn delete" type="submit" title="X√≥a" onclick="return confirm('X√≥a s·∫£n ph·∫©m n√†y?')">üóëÔ∏è</button>
        </form>
        <a href="{{ url_for('sanpham_view', ma=p.MaSP) }}" class="icon-btn detail" title="Xem chi ti·∫øt">
          üîç
          <div class="preview-box">
            <img src="{{ p.Anh or url_for('static', filename='img/noimage.png') }}" alt="{{ p.TenSP_ }}">
            <h4>{{ p.TenSP_ }}</h4>
            <p><b>M√£:</b> {{ p.MaSP }}</p>
            <p><b>Lo·∫°i:</b> {{ p.TenLoai or p.MaLoai }}</p>
            <p>
              <b>Gi√°:</b>
              <span class="price-new">{{ "{:,.0f}".format(p.DonGia) }}ƒë</span>
              <span class="price-old">{{ "{:,.0f}".format(p.GiaCu) }}ƒë</span>
            </p>
            <p class="desc"><b>M√¥ t·∫£:</b> {{ p.MoTa or 'Ch∆∞a c√≥ m√¥ t·∫£' }}</p>

            <!-- üïì Hi·ªÉn th·ªã th·ªùi gian c·∫≠p nh·∫≠t trong tooltip -->
            <p><b>üïì C·∫≠p nh·∫≠t:</b> {{ p.ThoiGianCapNhat.strftime('%d/%m/%Y %H:%M') if p.ThoiGianCapNhat else 'Ch∆∞a c√≥' }}</p>
          </div>
        </a>
      </div>
    </div>
  </div>
  {% endfor %}
</div>

<!-- Modal Chi ti·∫øt s·∫£n ph·∫©m -->
<div id="detailModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <div id="modal-body"></div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
function viewDetail(maSP) {
  fetch(`/api/sanpham/${maSP}`)
    .then(res => res.json())
    .then(p => {
      const body = document.getElementById("modal-body");
      body.innerHTML = `
        <h2>${p.TenSP_}</h2>
        <img src="${p.Anh}" alt="${p.TenSP_}" style="max-width:250px;border-radius:10px;margin:10px 0;">
        <p><b>Gi√°:</b> ${p.DonGia.toLocaleString('vi-VN')} ƒë</p>
        <p><b>M√¥ t·∫£:</b> ${p.MoTa || 'Ch∆∞a c√≥ m√¥ t·∫£'}</p>
        <p><b>Lo·∫°i:</b> ${p.MaLoai}</p>
      `;
      document.getElementById("detailModal").style.display = "block";
    });
}

function closeModal() {
  document.getElementById("detailModal").style.display = "none";
}

// H√†m hi·ªÉn th·ªã danh s√°ch s·∫£n ph·∫©m v√†o grid ch√≠nh
function renderProducts(products) {
  const grid = document.getElementById("productGrid");
  grid.innerHTML = "";

  if (products.length === 0) {
    grid.innerHTML = `
      <p id="no-product-msg" style="padding:20px; color:#888;">
        Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m
      </p>`;
    return;
  }

  products.forEach(p => {
    grid.innerHTML += `
      <div class="product-card">
        <img src="${p.Anh || '/static/img/noimage.png'}" alt="${p.TenSP_}">
        <div class="product-info">
          <h4>${p.TenSP_}</h4>

          <p class="category">
            Lo·∫°i: ${p.TenLoai || p.MaLoai}
          </p>

          <p class="price">
            ${Number(p.DonGia).toLocaleString('vi-VN')} ƒë
          </p>

          <small class="update-time">
            üïì C·∫≠p nh·∫≠t: ${p.ThoiGianCapNhat || 'Ch∆∞a c√≥'}
          </small>

          <div class="actions">
            <a href="/sanpham/edit/${p.MaSP}">
              <button class="icon-btn edit"><i>‚úèÔ∏è</i></button>
            </a>

            <form method="post" action="/sanpham/delete/${p.MaSP}" style="display:inline;">
              <button class="icon-btn delete"
                onclick="return confirm('X√≥a s·∫£n ph·∫©m n√†y?')">üóëÔ∏è</button>
            </form>

            <a href="/sanpham/view/${p.MaSP}" class="icon-btn detail" title="Xem chi ti·∫øt">
              üîç
              <div class="preview-box">
                <img src="${p.Anh || '/static/img/noimage.png'}">
                <h4>${p.TenSP_}</h4>
                <p><b>M√£:</b> ${p.MaSP}</p>
                <p><b>Lo·∫°i:</b> ${p.TenLoai || p.MaLoai}</p>
                <p>
                  <b>Gi√°:</b>
                  <span class="price-new">
                    ${Number(p.DonGia).toLocaleString('vi-VN')}ƒë
                  </span>
                  ${p.GiaCu ? `<span class="price-old">
                    ${Number(p.GiaCu).toLocaleString('vi-VN')}ƒë
                  </span>` : ""}
                </p>
                <p class="desc">
                  <b>M√¥ t·∫£:</b> ${p.MoTa || 'Ch∆∞a c√≥ m√¥ t·∫£'}
                </p>
              </div>
            </a>
          </div>
        </div>
      </div>
    `;
  });
}



// ‚úÖ T√¨m ki·∫øm s·∫£n ph·∫©m
function searchSanPham() {
  const query = document.getElementById("searchInput").value.trim();
  const suggestBox = document.getElementById("suggestions");
  if (!query) {
    suggestBox.innerHTML = "";
    suggestBox.style.display = "none";
    return;
  }

  fetch(`/api/search_sanpham?q=${encodeURIComponent(query)}`)
    .then(res => res.json())
    .then(data => {
      if (!Array.isArray(data)) {
        console.error("API tr·∫£ v·ªÅ sai ƒë·ªãnh d·∫°ng:", data);
        return;
      }
      if (data.length === 0) {
        suggestBox.innerHTML = `<div style="padding:8px;color:#888;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</div>`;
      } else {
        suggestBox.innerHTML = data.map(p => `
          <div class="suggestion-item"
               style="padding:8px; cursor:pointer; border-bottom:1px solid #eee;"
               onclick="goToProduct('${p.MaSP.trim()}')">
            <b>${p.TenSP_}</b> <span style="color:#888;">(${p.TenLoai})</span>
          </div>
        `).join("");
      }
      suggestBox.style.display = "block";
    })
    .catch(err => console.error("L·ªói fetch:", err));
}

function goToProduct(ma) {
  window.location.href = `/sanpham/view/${ma}`;
}

// ‚úÖ X·ª≠ l√Ω ph√≠m Enter
document.addEventListener("DOMContentLoaded", () => {
    const input = document.getElementById("searchInput");
    const suggestBox = document.getElementById("suggestions");

    let selectedIndex = -1;

    function updateActiveSuggestion() {
        const items = document.querySelectorAll("#suggestions .suggestion-item");

        items.forEach((item, index) => {
            if (index === selectedIndex) {
                item.classList.add("active");
                item.scrollIntoView({ block: "nearest" });
            } else {
                item.classList.remove("active");
            }
        });
    }

    // ====== G√ï CH·ªÆ ‚Üí G·ªåI API V√Ä RENDER G·ª¢I √ù ======
    input.addEventListener("input", () => {
        const query = input.value.trim();
        selectedIndex = -1; // reset

        if (!query) {
            suggestBox.style.display = "none";
            suggestBox.innerHTML = "";
            return;
        }

        fetch(`/api/search_sanpham?q=${encodeURIComponent(query)}`)
            .then(res => res.json())
            .then(data => {

                // Ki·ªÉm tra xem API c√≥ tr·∫£ v·ªÅ m·∫£ng kh√¥ng
                if (!Array.isArray(data) || data.length === 0) {
                    suggestBox.innerHTML = `<div style="padding:8px;color:#888;">Kh√¥ng t√¨m th·∫•y s·∫£n ph·∫©m</div>`;
                } else {

                    // üî• CH·ªà L·∫§Y 5 G·ª¢I √ù ƒê·∫¶U TI√äN
                    const limitData = data.slice(0, 5);

                    suggestBox.innerHTML = limitData.map(p => `
                        <div class="suggestion-item"
                            onclick="window.location.href='/sanpham/view/${p.MaSP.trim()}'">
                            <b>${p.TenSP_}</b>
                            <span>(${p.TenLoai})</span>
                        </div>
                    `).join("");
                }

                suggestBox.style.display = "block";
            })
            .catch(err => console.error("L·ªói fetch:", err));
    });


    // ====== PH√çM L√äN/XU·ªêNG/ENTER ======
    input.addEventListener("keydown", (e) => {
        const items = document.querySelectorAll("#suggestions .suggestion-item");

        if (items.length === 0) return;

        if (e.key === "ArrowDown") {
            e.preventDefault();
            selectedIndex = (selectedIndex + 1) % items.length;
            updateActiveSuggestion();
        }
        else if (e.key === "ArrowUp") {
            e.preventDefault();
            selectedIndex = (selectedIndex - 1 + items.length) % items.length;
            updateActiveSuggestion();
        }
        else if (e.key === "Enter") {
            if (selectedIndex >= 0) {
                e.preventDefault();
                items[selectedIndex].click();
            }
        }
    });

    // ====== ENTER KHI KH√îNG CH·ªåN ITEM ‚Üí T√åM KI·∫æM CH√çNH TH·ª®C ======
    input.addEventListener("keydown", (e) => {
        if (e.key !== "Enter") return;

        if (selectedIndex >= 0) return; // ƒë√£ x·ª≠ l√Ω b√™n tr√™n

        const query = input.value.trim();
        if (!query) return;

        e.preventDefault();
        suggestBox.style.display = "none";

      fetch(`/api/search_sanpham?q=${encodeURIComponent(query)}`)
        .then(res => res.json())
        .then(data => {
            renderProducts(data);   // ‚Üê LU√îN render danh s√°ch
        });

    });

    // ====== CLICK RA NGO√ÄI ‚Üí ·∫®N G·ª¢I √ù ======
        input.addEventListener("keydown", (e) => {
        if (e.key === "Enter") {
            suggestBox.style.display = "none";
        }
    });

    document.addEventListener("click", (e) => {
        if (!suggestBox.contains(e.target) && e.target !== input) {
            suggestBox.style.display = "none";
        }
    });
});


// Reset khi g√µ l·∫°i text
input.addEventListener("input", () => {
  selectedIndex = -1;
});

</script>
{% endblock %}
